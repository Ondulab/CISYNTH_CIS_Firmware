<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>CISYNTH Configuration</title>
        <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
        <link rel="icon" href="img/favicon.ico" type="image/x-icon">
        <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">
        <style>
            body {
                font-family: 'Orbitron', sans-serif;
                background-color: #222;
                color: #D4AF37;
                margin: 0;
                padding: 20px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
            
            img.logo-inverted {
                filter: invert(100%);
            }

            input[type="number"]::-webkit-inner-spin-button,
            input[type="number"]::-webkit-outer-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
            
            /* Pour Mozilla Firefox */
            input[type="number"] {
                -moz-appearance: textfield;
            }
    
            .main-wrapper {
                max-width: 600px;
                min-width: 400px;
                width: 100%;
                box-sizing: border-box;
                text-align: center;
            }
    
            .containerHead {
                width: 100%;
                box-sizing: border-box;
                text-align: center;
            }
    
            .title {
                color: #D4AF37;
                font-size: 24px;
                text-align: center;
                margin-bottom: 15px;
            }
    
            .container {
                width: 100%;
                border: 1px solid #D4AF37;
                padding: 20px;
                margin: 10px 0;
                border-radius: 8px;
                box-sizing: border-box;
            }
    
            .section {
                margin-bottom: 0px;
            }
    
            select, input, button {
                font-family: 'Orbitron', sans-serif;
                color: #FFFFFF;
                background-color: #333;
                border: 1px solid #D4AF37;
                outline: none;
                padding: 10px;
                margin: 5px 0;
                box-sizing: border-box;
                font-size: 16px;
                cursor: pointer;
                text-align: center;
                -moz-text-align-last: center;
                text-align-last: center;
            }
    
            input[disabled] {
                background-color: #222;
            }
    
            label {
                color: #D4AF37;
                background-color: transparent;
                padding: 10px;
                margin: 5px 0;
                box-sizing: border-box;
                font-size: 16px;
                cursor: pointer;
            }
    
            .dpi-button, .hand-button {
                padding: 10px 20px;
                margin: 5px;
                background-color: #444;
                color: #D4AF37;
                border: 2px solid #555;
                cursor: pointer;
                transition: background-color 0.3s, border-color 0.3s;
            }
    
            .dpi-button.selected, .hand-button.selected {
                background-color: #D4AF37;
                color: #222;
                border-color: #D4AF37;
            }
    
            button {
                color: #222;
                background-color: #D4AF37;
                transition-duration: 0.4s;
            }
    
            button:hover {
                background-color: #FFF;
                color: #222;
            }
    
            input[type="file"] {
                cursor: pointer;
            }
    
            .form-group {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 10px;
            }
            
            .form-group label {
                flex-basis: 25%;
                text-align: right;
                padding-right: 10px;
            }
            
            .form-group input, .form-group select, .form-group button {
                flex-grow: 1;
                margin-left: 5px;
                margin-right: 5px;
            }
            
            .input-group {
                display: flex;
                justify-content: space-between;
            }
            
            .network-input-group input, .firmware-input-group input {
                flex-grow: 1;
                width: calc(60% / 4 - 10px);
                margin-left: 5px;
                margin-right: 5px;
                text-align: center;
            }

            .firmware-input-group input {
                text-align: left;
                text-align-last: left;
            }
    
            .broadcast-button {
                padding: 10px 20px;
                margin: 5px;
                background-color: #444;
                color: #D4AF37;
                border: 2px solid #555;
                cursor: pointer;
                transition: background-color 0.3s, border-color 0.3s;
            }
            
            .broadcast-button.selected {
                background-color: #D4AF37;
                color: #222;
                border-color: #D4AF37;
            }
        </style>
    </head>
    <body>
        <div class="main-wrapper">
            <div class="containerHead">
                <img src="img/CISYNTH.png" alt="Logo Image" class="logo-inverted" style="width: 300px; height: 300px;">
            </div>    
            <h1>Configuration Page</h1>
            <hr style="border-color: #444;">
    
            <!-- CIS Parameters -->
            <div class="container">
                <span class="title">CIS Parameters</span>
                <div class="section">
                    <div class="form-group">
                        <label for="dpi">DPI</label>
                        <button id="dpi200" class="dpi-button" onclick="updateDPI('200')">200</button>
                        <button id="dpi400" class="dpi-button" onclick="updateDPI('400')">400</button>
                    </div>
                    <div class="form-group">
                        <label for="oversampling">OVSP</label>
                        <select id="oversampling" onchange="updateOversampling(this.value)">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="4">4</option>
                            <option value="8">8</option>
                            <option value="16">16</option>
                            <option value="32">32</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="freqValue">LPS</label>
                        <input id="freqValue" disabled/>
                    </div>
                    <div class="form-group">
                        <label for="handedness">Hand</label>
                        <button id="leftHand" class="hand-button" onclick="updateHand('0')">LEFT</button>
                        <button id="rightHand" class="hand-button" onclick="updateHand('1')">RIGHT</button>
                    </div>
                    <div class="button-container">
                        <button id="calibrateButton" onclick="startCalibration()">Start Calibration</button>
                    </div>
                </div>
            </div>
    
            <!-- Network Configuration -->
            <div class="container">
                <span class="title">Network Configuration</span>
                <div class="section">
                    <div class="form-group network-input-group">
                        <label>IP Address</label>
                            <input type="number" id="ipPart1" value="192" min="0" max="255">
                            <input type="number" id="ipPart2" value="168" min="0" max="255">
                            <input type="number" id="ipPart3" value="0" min="0" max="255">
                            <input type="number" id="ipPart4" value="10" min="0" max="255">
                    </div>
                    <div class="form-group network-input-group">
                        <label>Subnet Mask</label>
                            <input type="number" id="maskPart1" value="255" min="0" max="255">
                            <input type="number" id="maskPart2" value="255" min="0" max="255">
                            <input type="number" id="maskPart3" value="255" min="0" max="255">
                            <input type="number" id="maskPart4" value="0" min="0" max="255"> 
                    </div>
                    <div class="form-group">
                        <label for="port">UDP Port</label>
                            <input type="number" id="port" value="1151" min="0" max="65535"> 
                    </div>
                    <div class="form-group">
                        <label for="broadcast">Broadcast</label>
                        <button id="broadcastEnable" class="broadcast-button" onclick="setBroadcast('enable')">ENABLE</button>
                        <button id="broadcastDisable" class="broadcast-button" onclick="setBroadcast('disable')">DISABLE</button>
                    </div>
                    <div class="button-container">
                        <button id="updateNetworkBtn" onclick="">Apply Network Settings</button>
                    </div>
                </div>
            </div>
    
            <!-- Firmware Update -->
            <div class="container">
                <span class="title">Firmware Update</span>
                <div class="section">
                    <div class="form-group firmware-input-group">
                        <label for="firmwareFile">Select Firmware</label>
                        <input type="file" id="firmwareFile">
                    </div>
                    <div class="button-container">
                        <button onclick="uploadFirmware()">Upload Firmware</button>
                    </div>
                </div>
            </div>
        </div>     
    <script>
        var xhr;

        function initialize() {
            attachEventListeners();
            setBroadcast('disable');
            loadDPI();
            loadHand();
            loadOversampling();
            timer();

            var ipInputs = document.querySelectorAll('input[type="number"]');

            ipInputs.forEach(function(input) {
                input.addEventListener('input', function() {
                    this.value = this.value.replace(/\D/g, '');
                    
                    let num = parseInt(this.value, 10);
                    if (this.value === "")
                    {
                        return;
                    }
                    if (num > parseInt(this.max, 10)) {
                        this.value = this.max;
                    } else if (num < parseInt(this.min, 10) || isNaN(num)) {
                        this.value = this.min;
                    }
                });
            });
        }
        
        function attachEventListeners() {
            document.getElementById('updateNetworkBtn').addEventListener('click', updateNetworkConfig);
        }

        function updateNetworkConfig() {
            var xhr = new XMLHttpRequest();
            var ip1 = document.getElementById("ipPart1").value;
            var ip2 = document.getElementById("ipPart2").value;
            var ip3 = document.getElementById("ipPart3").value;
            var ip4 = document.getElementById("ipPart4").value;
            var mask1 = document.getElementById("maskPart1").value;
            var mask2 = document.getElementById("maskPart2").value;
            var mask3 = document.getElementById("maskPart3").value;
            var mask4 = document.getElementById("maskPart4").value;
            var port = document.getElementById("port").value;
            var broadcast = document.querySelector('button.broadcast-button.selected').textContent.toLowerCase() === 'enable';
        
            var ip = `${ip1}.${ip2}.${ip3}.${ip4}`;
            var mask = `${mask1}.${mask2}.${mask3}.${mask4}`;
        
            xhr.open("POST", "networkconfig", true);
            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr.send(`ip=${ip}&mask=${mask}&port=${port}&broadcast=${broadcast}`);
        }

        function uploadFirmware() {
            var xhr = new XMLHttpRequest();
            var fileInput = document.getElementById('firmwareFile');
            var file = fileInput.files[0];
        
            if (!file) {
                alert("Please select a file.");
                return;
            }
        
            var formData = new FormData();
            formData.append('firmwareFile', file);
        
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/uploadFirmware", true);
            xhr.onload = function () {
                if (xhr.status === 200) {
                    alert("Firmware uploaded successfully!");
                } else {
                    alert("Failed to upload firmware.");
                }
            };
            xhr.onerror = function () {
                alert("Error in network request.");
            };
            xhr.send(formData);
        }

        function loadDPI() {
            console.log("Loading DPI settings...");
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                console.log("XHR state: ", xhr.readyState, "Status: ", xhr.status);
                if (this.readyState == 4 && this.status == 200) {
                    console.log("Response received: ", this.responseText);
                    setDPI(this.responseText.trim());
                } else if (this.readyState == 4) {
                    console.error("Failed to load DPI settings, server responded with status: ", this.status);
                }
            };
            xhr.open("GET", "getDPI", true);
            xhr.send();
        }

        function updateDPI(newDPI) {
            var xhr = new XMLHttpRequest();
            if (!newDPI || isNaN(newDPI)) {
                alert("Invalid DPI value. Please enter a numeric value.");
                return;
            }
        
            xhr.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    console.log("DPI updated to", newDPI);
                    setDPI(newDPI.toString());
                }
            };
            xhr.open("POST", "setDPI", true);
            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr.send("dpi=" + newDPI);
        }
        
        function setDPI(value) {
            var buttons = document.querySelectorAll('.dpi-button');
            buttons.forEach(function(button) {
                button.classList.remove('selected');
                if (button.textContent.trim() === value) {
                    button.classList.add('selected');
                }
            });
        }

        function loadOversampling() {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    // Assuming the response is just the oversampling value
                    var select = document.getElementById('oversampling');
                    select.value = this.responseText.trim(); // Update the dropdown to reflect the current setting
                } else if (this.readyState == 4) {
                    console.error("Failed to load oversampling settings, server responded with status: ", this.status);
                }
            };
            xhr.open("GET", "/getOversampling", true);
            xhr.send();
        }
        
        function updateOversampling(newOversampling) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/setOversampling", true);
            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr.send("oversampling=" + newOversampling);
        
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && this.status == 200) {
                    console.log("Oversampling updated to: ", newOversampling);
                    setOversampling(newOversampling); // Update UI after server confirmation
                } else if (xhr.readyState == 4) {
                    console.error("Failed to update oversampling, server responded with status: ", this.status);
                }
            };
        }
        
        function setOversampling(value) {
            var select = document.getElementById('oversampling');
            select.value = value; // Set the dropdown to the current oversampling value
        }

        function loadHand() {
            console.log("Loading hand settings...");
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                console.log("XHR state: ", xhr.readyState, "Status: ", xhr.status);
                if (this.readyState == 4 && this.status == 200) {
                    console.log("Response received: ", this.responseText);
                    setHand(this.responseText.trim());
                } else if (this.readyState == 4) {
                    console.error("Failed to load Hand settings, server responded with status: ", this.status);
                }
            };
            xhr.open("GET", "getHand", true);
            xhr.send();
        }

        function updateHand(newHand) {
            var xhr = new XMLHttpRequest();
            if (!newHand || isNaN(newHand)) {
                alert("Invalid Hand value. Please enter a numeric value.");
                return;
            }
        
            xhr.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    console.log("Hand updated to", newHand);
                    setHand(newHand.toString());
                }
            };
            xhr.open("POST", "setHand", true);
            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr.send("hand=" + newHand);
        }
        
        function setHand(value) {
            var buttons = document.querySelectorAll('.hand-button');
            var handValue = "";
            if (value === "1") {
                handValue = "right";
            } else if (value === "0") {
                handValue = "left";
            }
        
            buttons.forEach(function(button) {
                button.classList.remove('selected');
                if (button.textContent.trim().toLowerCase() === handValue) {
                    button.classList.add('selected');
                }
            });
        }

        function startCalibration() {
            var xhr = new XMLHttpRequest();
        
            xhr.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    console.log("Calibration started successfully");
                }
            };
        
            xhr.open("POST", "startCalibration", true);
            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr.send("CIS_CAL_START");
        }

        function timer() {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    document.getElementById("freqValue").value = this.responseText;
                }
            };
            xhr.open("GET", "getFreq?_=" + new Date().getTime(), true);
            xhr.send();
            setTimeout(timer, 1000);
        }

        function setBroadcast(status) {
            var enableBtn = document.getElementById('broadcastEnable');
            var disableBtn = document.getElementById('broadcastDisable');
        
            if (status === 'enable') {
                enableBtn.classList.add('selected');
                disableBtn.classList.remove('selected');
            } else {
                enableBtn.classList.remove('selected');
                disableBtn.classList.add('selected');
            }
            console.log("Broadcast set to", status);
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
    </body>
</html>
