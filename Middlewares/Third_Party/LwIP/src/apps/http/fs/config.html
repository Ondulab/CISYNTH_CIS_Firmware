<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>CISYNTH Configuration</title>
        <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
        <link rel="icon" href="img/favicon_64x64.ico" type="image/x-icon">
        <style>
            body {
                font-family: 'Orbitron', sans-serif;
                background-color: #222;
                color: #D4AF37;
                margin: 0;
                padding: 20px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
            
            img.logo-inverted {
                filter: invert(100%);
            }

            input[type="number"]::-webkit-inner-spin-button,
            input[type="number"]::-webkit-outer-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
            
            /* Pour Mozilla Firefox */
            input[type="number"] {
                -moz-appearance: textfield;
            }
    
            .main-wrapper {
                max-width: 600px;
                min-width: 400px;
                width: 100%;
                box-sizing: border-box;
                text-align: center;
            }
    
            .containerHead {
                width: 100%;
                box-sizing: border-box;
                text-align: center;
            }
    
            .title {
                color: #D4AF37;
                font-size: 24px;
                text-align: center;
                margin-bottom: 15px;
            }
    
            .container {
                width: 100%;
                border: 1px solid #D4AF37;
                padding: 20px;
                margin: 10px 0;
                border-radius: 8px;
                box-sizing: border-box;
            }
    
            .section {
                margin-bottom: 0px;
            }
    
            select, input, button {
                font-family: 'Orbitron', sans-serif;
                color: #FFFFFF;
                background-color: #333;
                border: 1px solid #D4AF37;
                outline: none;
                padding: 10px;
                margin: 5px 0;
                box-sizing: border-box;
                font-size: 16px;
                cursor: pointer;
                text-align: center;
                -moz-text-align-last: center;
                text-align-last: center;
            }
    
            input[disabled] {
                background-color: #222;
            }
    
            label {
                color: #D4AF37;
                background-color: transparent;
                padding: 10px;
                margin: 5px 0;
                box-sizing: border-box;
                font-size: 16px;
                cursor: pointer;
            }
    
            .dpi-button, .hand-button {
                padding: 10px 20px;
                margin: 5px;
                background-color: #444;
                color: #D4AF37;
                border: 2px solid #555;
                cursor: pointer;
                transition: background-color 0.3s, border-color 0.3s;
            }
    
            .dpi-button.selected, .hand-button.selected {
                background-color: #D4AF37;
                color: #222;
                border-color: #D4AF37;
            }
    
            button {
                color: #222;
                background-color: #D4AF37;
                transition-duration: 0.4s;
            }
    
            button:hover {
                background-color: #FFF;
                color: #222;
            }
    
            input[type="file"] {
                cursor: pointer;
            }
    
            .form-group {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 10px;
            }
            
            .form-group label {
                flex-basis: 25%;
                text-align: right;
                padding-right: 10px;
            }
            
            .form-group input, .form-group select, .form-group button {
                flex-grow: 1;
                width: calc(60% / 4 - 10px);
                margin-left: 5px;
                margin-right: 5px;
            }
            
            .input-group {
                display: flex;
                justify-content: space-between;
            }
            
            .network-input-group input, .firmware-input-group input {
                flex-grow: 1;
                width: calc(60% / 4 - 10px);
                margin-left: 5px;
                margin-right: 5px;
                text-align: center;
            }

            .firmware-input-group input {
                text-align: left;
                text-align-last: left;
            }
    
            .broadcast-button {
                padding: 10px 20px;
                margin: 5px;
                background-color: #444;
                color: #D4AF37;
                border: 2px solid #555;
                cursor: pointer;
                transition: background-color 0.3s, border-color 0.3s;
            }
            
            .broadcast-button.selected {
                background-color: #D4AF37;
                color: #222;
                border-color: #D4AF37;
            }
        </style>
    </head>
    <body>
        <div class="main-wrapper">
            <div class="containerHead">
                <img src="img/CISYNTH.png" alt="Logo Image" class="logo-inverted" style="width: 300px; height: 300px;">
            </div>    
            <h1>Configuration Page</h1>
            <hr style="border-color: #444;">
    
            <!-- CIS Parameters -->
            <div class="container">
                <span class="title">CIS Parameters</span>
                <div class="section">
                    <div class="form-group">
                        <label for="dpi">DPI</label>
                        <button id="dpi200" class="dpi-button" onclick="updateDPI('200')">200</button>
                        <button id="dpi400" class="dpi-button" onclick="updateDPI('400')">400</button>
                    </div>
                    <div class="form-group">
                        <label for="oversampling">OVSP</label>
                        <select id="oversampling" onchange="updateOversampling(this.value)">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="4">4</option>
                            <option value="8">8</option>
                            <option value="16">16</option>
                            <option value="32">32</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="freqValue">LPS</label>
                        <input id="freqValue" disabled/>
                    </div>
                    <div class="form-group">
                        <label for="handedness">Hand</label>
                        <button id="leftHand" class="hand-button" onclick="updateHand('0')">LEFT</button>
                        <button id="rightHand" class="hand-button" onclick="updateHand('1')">RIGHT</button>
                    </div>
                    <div class="button-container">
                        <button id="calibrateButton" onclick="startCalibration()">Start Calibration</button>
                    </div>
                </div>
            </div>
    
            <!-- Network Configuration -->
            <div class="container">
                <span class="title">Network Configuration</span>
                <div class="section">
                    <div class="form-group network-input-group">
                        <label>IP Addr</label>
                            <input type="number" id="ipPart1" min="0" max="255">
                            <input type="number" id="ipPart2" min="0" max="255">
                            <input type="number" id="ipPart3" min="0" max="255">
                            <input type="number" id="ipPart4" min="0" max="255">
                    </div>
                    <div class="form-group network-input-group">
                        <label>Subnet Mask</label>
                            <input type="number" id="maskPart1" min="0" max="255">
                            <input type="number" id="maskPart2" min="0" max="255">
                            <input type="number" id="maskPart3" min="0" max="255">
                            <input type="number" id="maskPart4" min="0" max="255"> 
                    </div>
                    <div class="form-group network-input-group">
                        <label>Gateway</label>
                            <input type="number" id="gateway1" min="0" max="255">
                            <input type="number" id="gateway2" min="0" max="255">
                            <input type="number" id="gateway3" min="0" max="255">
                            <input type="number" id="gateway4" min="0" max="255"> 
                    </div>
                    <div class="form-group network-input-group">
                        <label>Dest IP Addr</label>
                            <input type="number" id="ipDestPart1" min="0" max="255">
                            <input type="number" id="ipDestPart2" min="0" max="255">
                            <input type="number" id="ipDestPart3" min="0" max="255">
                            <input type="number" id="ipDestPart4" min="0" max="255"> 
                    </div>
                    <div class="form-group">
                        <label for="port">UDP Port</label>
                            <input type="number" id="port" min="0" max="65535"> 
                    </div>
                    <div class="form-group">
                        <label for="broadcast">Bcast</label>
                        <button id="broadcastEnable" class="broadcast-button" onclick="setBroadcast('enable')">ENABLE</button>
                        <button id="broadcastDisable" class="broadcast-button" onclick="setBroadcast('disable')">DISABLE</button>
                    </div>
                    <div class="button-container">
                        <button id="updateNetworkBtn" onclick="updateNetworkConfig()">Apply Network Settings</button>
                    </div>
                </div>
            </div>

            <!-- Firmware Update -->
            <div class="container">
                <span class="title">Firmware Update</span>
                <div class="section">
                    <div class="form-group firmware-input-group">
                        <label for="firmwareFile">Select Firmware</label>
                        <input type="file" id="firmwareFile">
                    </div>
                    <div class="button-container">
                        <button onclick="uploadFirmware()">Upload Firmware</button>
                    </div>
                </div>
            </div>

            <!-- Progress Modal -->
            <div id="progressModal" style="display:none;">
                <progress id="uploadProgress" value="0" max="100" style="width: 100%;"></progress> <!-- Progress Bar -->
                <p id="uploadStatus">No upload in progress.</p> <!-- Status Message -->
            </div>
        </div>    
        <script src="https://cdn.jsdelivr.net/npm/crc-32/crc32.min.js"></script>
        <script>
            function initialize() {
                setupInputListeners().then(() => {
                    console.log("Input listeners setup completed.");
                    return loadDPI();
                })
                .then(() => loadHand())
                .then(() => loadOversampling())
                .then(() => loadNetworkConfig())
                .then(() => timer())
                .catch(error => {
                    console.error("Initialization failed:", error);
                });
            }
        
            function setupInputListeners() {
                return new Promise(resolve => {
                    var ipInputs = document.querySelectorAll('input[type="number"]');
                    ipInputs.forEach(function(input) {
                        input.addEventListener('input', function() {
                            this.value = this.value.replace(/\D/g, '');
                            let num = parseInt(this.value, 10);
                            if (this.value === "") {
                                return;
                            }
                            if (num > parseInt(this.max, 10)) {
                                this.value = this.max;
                            } else if (num < parseInt(this.min, 10) || isNaN(num)) {
                                this.value = this.min;
                            }
                        });
                    });
                    resolve();
                });
            }

            function timer() {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        document.getElementById("freqValue").value = this.responseText;
                    }
                };
                xhr.open("GET", "getFreq?_=" + new Date().getTime(), true);
                xhr.send();
                setTimeout(timer, 1000);
            }
        
            function loadNetworkConfig() {
                return new Promise((resolve, reject) => {
                    var xhr = new XMLHttpRequest();
                    xhr.open("GET", "/getNetworkConfig", true);
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            var config = JSON.parse(xhr.responseText);
                            document.getElementById("ipPart1").value = config.ip.split('.')[0];
                            document.getElementById("ipPart2").value = config.ip.split('.')[1];
                            document.getElementById("ipPart3").value = config.ip.split('.')[2];
                            document.getElementById("ipPart4").value = config.ip.split('.')[3];
                            document.getElementById("maskPart1").value = config.mask.split('.')[0];
                            document.getElementById("maskPart2").value = config.mask.split('.')[1];
                            document.getElementById("maskPart3").value = config.mask.split('.')[2];
                            document.getElementById("maskPart4").value = config.mask.split('.')[3];
                            document.getElementById("gateway1").value = config.gw.split('.')[0];
                            document.getElementById("gateway2").value = config.gw.split('.')[1];
                            document.getElementById("gateway3").value = config.gw.split('.')[2];
                            document.getElementById("gateway4").value = config.gw.split('.')[3];
                            document.getElementById("ipDestPart1").value = config.dest_ip.split('.')[0];
                            document.getElementById("ipDestPart2").value = config.dest_ip.split('.')[1];
                            document.getElementById("ipDestPart3").value = config.dest_ip.split('.')[2];
                            document.getElementById("ipDestPart4").value = config.dest_ip.split('.')[3];
                            document.getElementById("port").value = config.udp_port;
                            var broadcastButton = config.broadcast ? 'broadcastEnable' : 'broadcastDisable';
                            document.getElementById(broadcastButton).click();
                            resolve();
                        } else {
                            console.error("Failed to load network settings:", xhr.statusText);
                            reject(new Error("Network configuration failed to load with status: " + xhr.status));
                        }
                    };
                    xhr.onerror = () => reject(new Error("Network request failed"));
                    xhr.send();
                });
            }

            function updateNetworkConfig() {
                return new Promise((resolve, reject) => {
                    // Collect network configuration data from input fields
                    const ipAddr = [
                        document.getElementById("ipPart1").value,
                        document.getElementById("ipPart2").value,
                        document.getElementById("ipPart3").value,
                        document.getElementById("ipPart4").value
                    ].join('.');
            
                    const subnetMask = [
                        document.getElementById("maskPart1").value,
                        document.getElementById("maskPart2").value,
                        document.getElementById("maskPart3").value,
                        document.getElementById("maskPart4").value
                    ].join('.');

                    const gateway = [
                        document.getElementById("gateway1").value,
                        document.getElementById("gateway2").value,
                        document.getElementById("gateway3").value,
                        document.getElementById("gateway4").value
                    ].join('.');
            
                    const destIpAddr = [
                        document.getElementById("ipDestPart1").value,
                        document.getElementById("ipDestPart2").value,
                        document.getElementById("ipDestPart3").value,
                        document.getElementById("ipDestPart4").value
                    ].join('.');
            
                    const udpPort = document.getElementById("port").value;
                    const broadcastEnable = document.getElementById("broadcastEnable").classList.contains('selected') ? '1' : '0';
            
                    // Construct the POST request data
                    const data = `ip=${ipAddr}&mask=${subnetMask}&gateway=${gateway}&dest_ip=${destIpAddr}&udp_port=${udpPort}&broadcast=${broadcastEnable}`;
            
                    // Create and send the HTTP POST request
                    const xhr = new XMLHttpRequest();
                    xhr.open("POST", "/updateNetworkConfig", true);
                    xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            console.log("Network configuration updated successfully.");
                            resolve();
                        } else {
                            console.error("Failed to update network configuration:", xhr.statusText);
                            reject(new Error("Failed to update network configuration with status: " + xhr.status));
                        }
                    };
            
                    xhr.onerror = function() {
                        console.error("Network request failed.");
                        reject(new Error("Network request error"));
                    };
            
                    xhr.send(data);
                });
            }

            function uploadFirmware() {
                const file = document.getElementById('firmwareFile').files[0];
                if (!file) {
                    alert('Please select a file to upload.');
                    return;
                }
            
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileData = new Uint8Array(e.target.result);

                    const crc = CRC32.buf(fileData); // Calculate CRC of the file
                    const crcHex = (crc >>> 0).toString(16); // Convert to unsigned hex string

                    console.log("CRC calculated: ", crcHex); // Afficher le CRC calculé en hexadécimal

                    const formData = new FormData();
                    
                    formData.append('crc', crcHex); // Add calculated CRC to FormData
                    formData.append('firmwareFile', file);
            
                    const xhr = new XMLHttpRequest();
                    xhr.open("POST", "/uploadFirmware", true);
                    //xhr.setRequestHeader("Content-Type", "multipart/form-data; charset=utf-8");

                    document.getElementById('progressModal').style.display = 'block';
            
                    xhr.upload.onprogress = function(event) {
                        if (event.lengthComputable) {
                            const percentComplete = (event.loaded / event.total) * 100;
                            document.getElementById('uploadProgress').value = percentComplete;
                            document.getElementById('uploadStatus').textContent = 'Uploading... ' + percentComplete.toFixed(2) + '%';
                        }
                    };
            
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            document.getElementById('uploadStatus').textContent = 'Firmware successfully uploaded! Please wait for the device to restart...';
                            setTimeout(() => {
                                document.getElementById('uploadStatus').textContent = 'Reconnecting, please do not disconnect the device.';
                            }, 1000);
                        } else {
                            document.getElementById('uploadStatus').textContent = 'Firmware upload failed.';
                        }
                    };
            
                    xhr.onerror = function() {
                        alert('Error in network request.');
                        document.getElementById('uploadStatus').textContent = 'Network error, please try again.';
                    };
            
                    xhr.send(formData);
                };
                reader.readAsArrayBuffer(file); // Read the file as buffer to calculate CRC
            }







            function setDPI(value) {
                var buttons = document.querySelectorAll('.dpi-button');
                buttons.forEach(function(button) {
                    button.classList.remove('selected');
                    if (button.textContent.trim() === value) {
                        button.classList.add('selected');
                    }
                });
            }

            // Load DPI Settings
            function loadDPI() {
                return new Promise((resolve, reject) => {
                    var xhr = new XMLHttpRequest();
                    xhr.open("GET", "getDPI", true);
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            console.log("DPI settings loaded:", xhr.responseText);
                            setDPI(xhr.responseText.trim());
                            resolve();
                        } else {
                            console.error("Failed to load DPI settings:", xhr.statusText);
                            reject(new Error("Failed to load DPI settings with status: " + xhr.status));
                        }
                    };
                    xhr.onerror = () => reject(new Error("Network request failed"));
                    xhr.send();
                });
            }
            
            // Update DPI Settings
            function updateDPI(newDPI) {
                return new Promise((resolve, reject) => {
                    if (!newDPI || isNaN(newDPI)) {
                        alert("Invalid DPI value. Please enter a numeric value.");
                        reject(new Error("Invalid DPI value"));
                        return;
                    }
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "setDPI", true);
                    xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            console.log("DPI updated to", newDPI);
                            setDPI(newDPI.toString());
                            resolve();
                        } else {
                            console.error("Failed to update DPI settings:", xhr.statusText);
                            reject(new Error("Failed to update DPI settings with status: " + xhr.status));
                        }
                    };
                    xhr.onerror = () => reject(new Error("Network request failed"));
                    xhr.send("dpi=" + newDPI);
                });
            }
            
            function setOversampling(value) {
                var select = document.getElementById('oversampling');
                select.value = value; // Set the dropdown to the current oversampling value
            }

            // Load Oversampling Settings
            function loadOversampling() {
                return new Promise((resolve, reject) => {
                    var xhr = new XMLHttpRequest();
                    xhr.open("GET", "/getOversampling", true);
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            var select = document.getElementById('oversampling');
                            select.value = xhr.responseText.trim();
                            console.log("Oversampling settings loaded:", xhr.responseText);
                            resolve();
                        } else {
                            console.error("Failed to load oversampling settings:", xhr.statusText);
                            reject(new Error("Failed to load oversampling settings with status: " + xhr.status));
                        }
                    };
                    xhr.onerror = () => reject(new Error("Network request failed"));
                    xhr.send();
                });
            }
            
            // Update Oversampling Settings
            function updateOversampling(newOversampling) {
                return new Promise((resolve, reject) => {
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "/setOversampling", true);
                    xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            console.log("Oversampling updated to:", newOversampling);
                            setOversampling(newOversampling);
                            resolve();
                        } else {
                            console.error("Failed to update oversampling settings:", xhr.statusText);
                            reject(new Error("Failed to update oversampling settings with status: " + xhr.status));
                        }
                    };
                    xhr.onerror = () => reject(new Error("Network request failed"));
                    xhr.send("oversampling=" + newOversampling);
                });
            }
            
            function setHand(value) {
                var buttons = document.querySelectorAll('.hand-button');
                var handValue = "";
                if (value === "1") {
                    handValue = "right";
                } else if (value === "0") {
                    handValue = "left";
                }
            
                buttons.forEach(function(button) {
                    button.classList.remove('selected');
                    if (button.textContent.trim().toLowerCase() === handValue) {
                        button.classList.add('selected');
                    }
                });
            }

            // Load Hand Settings
            function loadHand() {
                return new Promise((resolve, reject) => {
                    var xhr = new XMLHttpRequest();
                    xhr.open("GET", "getHand", true);
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            console.log("Hand settings loaded:", xhr.responseText);
                            setHand(xhr.responseText.trim());
                            resolve();
                        } else {
                            console.error("Failed to load hand settings:", xhr.statusText);
                            reject(new Error("Failed to load hand settings with status: " + xhr.status));
                        }
                    };
                    xhr.onerror = () => reject(new Error("Network request failed"));
                    xhr.send();
                });
            }
            
            // Update Hand Settings
            function updateHand(newHand) {
                return new Promise((resolve, reject) => {
                    if (!newHand || isNaN(newHand)) {
                        alert("Invalid hand value. Please enter a numeric value.");
                        reject(new Error("Invalid hand value"));
                        return;
                    }
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "setHand", true);
                    xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            console.log("Hand updated to", newHand);
                            setHand(newHand.toString());
                            resolve();
                        } else {
                            console.error("Failed to update hand settings:", xhr.statusText);
                            reject(new Error("Failed to update hand settings with status: " + xhr.status));
                        }
                    };
                    xhr.onerror = () => reject(new Error("Network request failed"));
                    xhr.send("hand=" + newHand);
                });
            }
            
            // Start Calibration
            function startCalibration() {
                return new Promise((resolve, reject) => {
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "startCalibration", true);
                    xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            console.log("Calibration started successfully");
                            resolve();
                        } else {
                            console.error("Failed to start calibration:", xhr.statusText);
                            reject(new Error("Failed to start calibration with status: " + xhr.status));
                        }
                    };
                    xhr.onerror = () => reject(new Error("Network request failed"));
                    xhr.send("CIS_CAL_START");
                });
            }
            
            function setBroadcast(status) {
                return new Promise((resolve, reject) => {
                    var enableBtn = document.getElementById('broadcastEnable');
                    var disableBtn = document.getElementById('broadcastDisable');
                
                    if (status === 'enable') {
                        enableBtn.classList.add('selected');
                        disableBtn.classList.remove('selected');
                    } else {
                        enableBtn.classList.remove('selected');
                        disableBtn.classList.add('selected');
                    }
                    console.log("Broadcast set to", status);
                    resolve();  // Resolve immediately as this is a synchronous UI update
                });
            }

            document.addEventListener('DOMContentLoaded', initialize);
        </script>
    </body>
</html>
